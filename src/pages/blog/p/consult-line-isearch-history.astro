---
import BlogPost from '../../../layouts/BlogPost.astro';
---

<BlogPost
  title="Connecting consult-line with isearch history"
  description="Adding the latest consult-line search term to isearch history for easy search continuation"
  slug="consult-line-isearch-history"
  publishedDate="2024-01-17"
  hasPrism={true}
>
  <h1 class="post-title">Connecting consult-line with isearch history</h1>
  <time datetime="2024-01-17">January 17, 2024</time>

  <div class="post-main">
    <div class="blog-body">
      <p>I've recently jumped on the not-so-new hotness of <a href="">Consult</a>, with its friends <a href="">Vertico</a> and <a href="">Orderless</a>, replacing the still strong but slightly slower <a href="">Counsel</a>, <a href="">Ivy</a>, <a href="">Swiper</a> and <a href="">Flx</a>. There's been a few bumps along the way to adapt these new packages to my own whims, but its all working out so far.</p>
        <p>One such issue is that after using <code>consult-line</code> to search in a buffer, I'd often like to continue my search, preferring the <code>evil-mode</code> keys <code>n</code> and <code>N</code> (<code>evil-search-next</code> and <code>evil-search-previous</code>, respectively). Unfortunately, once <code>consult-line</code> is closed, it can't be resumed without starting it again anew, unlike the <code>swiper</code> behavior I've come to rely on.</p>
      <p>Now I did come across a <a href="https://github.com/minad/consult/issues/318">2021 GitHub thread about this issue</a>, but the chosen solution only works for <code>evil-search</code> as the search module. This is not the default and, though I'm sure many love it, I prefer the isearch way of highlighting. So, taking inspiration from that thread, I've made my own advice for <code>consult-line</code> which instead works by connecting <code>consult</code>'s <code>consult--line-history</code> with the <code>regexp-search-ring</code> that <code>isearch</code> uses.</p>
      <pre lang="lisp"><code class="language-lisp">(defun consult-line-isearch-history (&rest _)
    "Add latest `consult-line' search pattern to the isearch history.

This allows n and N to continue the search after `consult-line' exits."
    (when (and (bound-and-true-p evil-mode)
               (eq evil-search-module 'isearch)
               consult--line-history)
      (let* ((pattern (car consult--line-history))
             (regexp (if (string-prefix-p "\\_" pattern)
                         (substring pattern 2)
                       pattern)))
        (add-to-history 'regexp-search-ring regexp)
        (setq evil-ex-search-pattern (evil-ex-pattern regexp t nil nil))
        (setq evil-ex-search-direction 'forward))))

;; Now tell consult-line to run the function after a search
(advice-add #'consult-line :after #'consult-line-isearch-history)</code></pre>
    </div>
  </div>

  <hr />
  <div>
    <p>Check out my <a href="https://github.com/thornjad/aero">full Emacs configuration</a> if you'd like to see how else I bend Emacs to my will.</p>
  </div>
</BlogPost>
