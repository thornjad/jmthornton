---
import Base from '../../layouts/Base.astro';
---

<Base
  title="Midpoint Calculator | Jade Michael Thornton"
  description="Calculate the midpoint between two or more lat/lon coordinates"
  fontStrategy="prefetch"
>
  <Fragment slot="head">
    <style>
      section {
        display: flex;
        flex-direction: column;
        gap: 0.5em;
      }

      span {
        display: flex;
        gap: 0.5em;
        line-height: 1.5em;
      }

      input {
        text-align: right;
      }

      button {
        width: 6em;

        &#add-point:not(:hover) {
          background-color: transparent;
          color: inherit;
        }

        &.remove-point {
          padding: 2px 8px;
          width: auto;
        }
      }

      div.action-buttons {
        justify-content: start;
        margin-top: 2em;
      }

      .remove-point {
        margin-left: 1em;
      }

      .input-type {
        margin-bottom: 0.5em;
      }

      .city-input {
        width: 200px;
        text-align: left;
      }

      .coordinates-inputs {
        display: none;
      }

      .city-inputs {
        display: none;
      }
    </style>
  </Fragment>

  <h1>Midpoint Calculator</h1>
  <h3>Calculate the midpoint between two or more lat/lon coordinates</h3>

  <noscript>Sorry, this tool requires Javascript.</noscript>

  <section>
    <div id="coordinates-container">
      <div class="point-group">
        <p><strong>Point 1:</strong></p>
        <div class="input-type">
          <input type="radio" name="input-type-1" value="city" checked />
          City
          <input type="radio" name="input-type-1" value="coordinates" />
          Lat/Lon
        </div>
        <div class="city-inputs">
          <span>
            <input
              type="text"
              placeholder="e.g. New York, NY"
              class="city-input"
            />
            <button onclick="lookupCity(this)">Lookup</button>
          </span>
        </div>
        <div class="coordinates-inputs">
          <span>
            <input
              type="number"
              step="any"
              placeholder="e.g. 40.7128"
              class="lat-input"
            />
            <label>Latitude</label>
          </span>
          <span>
            <input
              type="number"
              step="any"
              placeholder="e.g. -74.0060"
              class="lon-input"
            />
            <label>Longitude</label>
          </span>
        </div>
      </div>

      <div class="point-group">
        <p><strong>Point 2:</strong></p>
        <div class="input-type">
          <input type="radio" name="input-type-2" value="city" checked />
          City
          <input type="radio" name="input-type-2" value="coordinates" />
          Lat/Lon
        </div>
        <div class="city-inputs">
          <span>
            <input
              type="text"
              placeholder="e.g. Los Angeles, CA"
              class="city-input"
            />
            <button onclick="lookupCity(this)">Lookup</button>
          </span>
        </div>
        <div class="coordinates-inputs">
          <span>
            <input
              type="number"
              step="any"
              placeholder="e.g. 34.0522"
              class="lat-input"
            />
            <label>Latitude</label>
          </span>
          <span>
            <input
              type="number"
              step="any"
              placeholder="e.g. -118.2437"
              class="lon-input"
            />
            <label>Longitude</label>
          </span>
        </div>
      </div>
    </div>

    <div class="action-buttons">
      <button id="calculate">Calculate</button>
      <button id="add-point">Add Point</button>
    </div>
  </section>

  <div id="error"></div>

  <blockquote id="output-wrapper" style="display: none">
    <h3>Midpoint Result:</h3>
    <p>Coordinates: <span id="midpoint-coords"></span></p>
    <p>Nearest City: <span id="midpoint-city">Looking up...</span></p>
    <p>
      <a id="google-maps-link" href="#" target="_blank"
        >View on Google Maps</a
      >
    </p>
  </blockquote>

  <script is:inline>
    "use strict";

    let pointCounter = 3;

    // handle radio button changes
    document.addEventListener("change", function (e) {
      if (e.target.type === "radio") {
        const pointGroup = e.target.closest(".point-group");
        const cityInputs = pointGroup.querySelector(".city-inputs");
        const coordinatesInputs = pointGroup.querySelector(
          ".coordinates-inputs",
        );

        if (e.target.value === "city") {
          cityInputs.style.display = "block";
          coordinatesInputs.style.display = "none";
        } else {
          cityInputs.style.display = "none";
          coordinatesInputs.style.display = "block";
        }
      }
    });

    // initialize first two points
    document.querySelectorAll(".point-group").forEach((group, index) => {
      const cityInputs = group.querySelector(".city-inputs");
      const coordinatesInputs = group.querySelector(".coordinates-inputs");
      cityInputs.style.display = "block";
      coordinatesInputs.style.display = "none";
    });

    async function lookupCity(button) {
      const cityInput = button.previousElementSibling;
      const city = cityInput.value.trim();

      if (!city) {
        showError("Please enter a city name");
        return;
      }

      button.textContent = "Looking up...";
      button.disabled = true;

      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(city)}&format=json&limit=1`,
        );

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.length === 0) {
          showError(`City not found: ${city}`);
          return;
        }

        const result = data[0];
        const lat = parseFloat(result.lat);
        const lon = parseFloat(result.lon);

        // find the corresponding lat/lon inputs in this point group
        const pointGroup = button.closest(".point-group");
        const latInput = pointGroup.querySelector(".lat-input");
        const lonInput = pointGroup.querySelector(".lon-input");

        latInput.value = lat;
        lonInput.value = lon;

        // switch to coordinates view and show success
        const radio = pointGroup.querySelector('input[value="coordinates"]');
        radio.checked = true;
        pointGroup.querySelector(".city-inputs").style.display = "none";
        pointGroup.querySelector(".coordinates-inputs").style.display =
          "block";

        showError(`Found: ${result.display_name}`, "success");
      } catch (error) {
        showError(`Error looking up city: ${error.message}`);
      } finally {
        button.textContent = "Lookup";
        button.disabled = false;
      }
    }

    function showError(message, type = "error") {
      const error = document.getElementById("error");
      error.textContent = message;
      error.style.display = "block";
      error.style.color = type === "success" ? "green" : "red";

      if (type === "success") {
        setTimeout(() => {
          error.style.display = "none";
        }, 3000);
      }
    }

    async function lookupNearestCity(lat, lon) {
      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&zoom=14`,
        );

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.error) {
          document.getElementById("midpoint-city").textContent =
            "City not found";
          return;
        }

        // extract more specific location information
        const address = data.address;
        let locationName = "";

        // try to build a more specific location name
        if (address.city) {
          locationName = address.city;
          if (address.state) {
            locationName += `, ${address.state}`;
          }
        } else if (address.town) {
          locationName = address.town;
          if (address.state) {
            locationName += `, ${address.state}`;
          }
        } else if (address.village) {
          locationName = address.village;
          if (address.state) {
            locationName += `, ${address.state}`;
          }
        } else if (address.county) {
          locationName = address.county;
          if (address.state) {
            locationName += `, ${address.state}`;
          }
        } else if (address.state) {
          locationName = address.state;
          if (address.country) {
            locationName += `, ${address.country}`;
          }
        } else {
          // fallback: use first two parts of display name
          const parts = data.display_name.split(",");
          locationName = parts.slice(0, 2).join(", ").trim();
        }

        document.getElementById("midpoint-city").textContent = locationName;
      } catch (error) {
        document.getElementById("midpoint-city").textContent =
          "Error looking up city";
      }
    }

    function addPoint() {
      const container = document.getElementById("coordinates-container");
      const newPoint = document.createElement("div");
      newPoint.className = "point-group";
      newPoint.innerHTML = `
        <p><strong>Point ${pointCounter}:</strong> <button class="remove-point" onclick="removePoint(this)">Remove</button></p>
        <div class="input-type">
          <input type="radio" name="input-type-${pointCounter}" value="city" checked> City
          <input type="radio" name="input-type-${pointCounter}" value="coordinates"> Lat/Lon
        </div>
        <div class="city-inputs">
          <span>
            <input type="text" placeholder="e.g. Chicago, IL" class="city-input" />
            <button onclick="lookupCity(this)">Lookup</button>
          </span>
        </div>
        <div class="coordinates-inputs">
          <span>
            <input type="number" step="any" placeholder="e.g. 41.8781" class="lat-input" />
            <label>Latitude</label>
          </span>
          <span>
            <input type="number" step="any" placeholder="e.g. -87.6298" class="lon-input" />
            <label>Longitude</label>
          </span>
        </div>
      `;
      container.appendChild(newPoint);

      // initialize the new point
      const cityInputs = newPoint.querySelector(".city-inputs");
      const coordinatesInputs = newPoint.querySelector(".coordinates-inputs");
      cityInputs.style.display = "block";
      coordinatesInputs.style.display = "none";

      pointCounter++;
    }

    function removePoint(button) {
      const pointDiv = button.closest(".point-group");
      if (document.querySelectorAll(".remove-point").length > 1) {
        pointDiv.remove();
        // update labels
        const points = document.querySelectorAll(".point-group");
        points.forEach((point, index) => {
          const label = point.querySelector("strong");
          label.textContent = `Point ${index + 1}:`;
        });
        pointCounter--;
      }
    }

    function calculateMidpoint() {
      const latInputs = document.querySelectorAll(".lat-input");
      const lonInputs = document.querySelectorAll(".lon-input");
      const error = document.getElementById("error");
      const outputWrapper = document.getElementById("output-wrapper");

      // hide previous results
      error.style.display = "none";
      outputWrapper.style.display = "none";

      const lats = [];
      const lons = [];

      // collect valid coordinates
      for (let i = 0; i < latInputs.length; i++) {
        const lat = parseFloat(latInputs[i].value);
        const lon = parseFloat(lonInputs[i].value);

        if (isNaN(lat) || isNaN(lon)) {
          continue; // skip empty inputs
        }

        if (lat < -90 || lat > 90) {
          showError(
            `Error: Latitude must be between -90 and 90 degrees (found ${lat})`,
          );
          return;
        }

        if (lon < -180 || lon > 180) {
          showError(
            `Error: Longitude must be between -180 and 180 degrees (found ${lon})`,
          );
          return;
        }

        lats.push(lat);
        lons.push(lon);
      }

      if (lats.length < 2) {
        showError("Error: Please enter at least 2 valid coordinate pairs");
        return;
      }

      // calculate midpoint
      const avgLat = lats.reduce((sum, lat) => sum + lat, 0) / lats.length;
      const avgLon = lons.reduce((sum, lon) => sum + lon, 0) / lons.length;

      // display result
      document.getElementById("midpoint-coords").textContent =
        `${avgLat.toFixed(6)}, ${avgLon.toFixed(6)}`;
      outputWrapper.style.display = "block";

      // update google maps link
      const googleMapsLink = document.getElementById("google-maps-link");
      googleMapsLink.href = `https://www.google.com/maps?q=${avgLat.toFixed(6)},${avgLon.toFixed(6)}`;

      // lookup nearest city
      lookupNearestCity(avgLat, avgLon);
    }

    document.getElementById("add-point").addEventListener("click", addPoint);
    document
      .getElementById("calculate")
      .addEventListener("click", calculateMidpoint);
  </script>
</Base>
