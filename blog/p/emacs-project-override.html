<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Overriding project.el project root in Emacs | Blog | Jade Michael Thornton</title>

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link type="text/plain" rel="author" href="https://jmthornton.net/humans.txt" />

    <meta name="robots" content="index, follow" />
    <meta name="googlebot" content="index, follow" />
    <meta name="google-site-verification" content="JUM1Dl9n9ic9xPMb03Nzf4NgW_-8PWZrJ4eJGC_PoYM" />
    <link rel="shortcut icon" href="https://jmthornton.net/assets/images/favicon.png" />
    <link rel="apple-itouch-icon" href="https://jmthornton.net/assets/images/favicon.ico" />
    <link
      rel="prefetch"
      href="https://jmthornton.net/assets/fonts/MetroNova-Regular.woff2"
      as="font"
      type="font/woff2"
      crossorigin="anonymous"
    />
    <link
      rel="prefetch"
      href="https://jmthornton.net/assets/fonts/MetroNova-Italic.woff2"
      as="font"
      type="font/woff2"
      crossorigin="anonymous"
    />
    <link
      rel="prefetch"
      href="https://jmthornton.net/assets/fonts/MetroNova-Bold.woff2"
      as="font"
      type="font/woff2"
      crossorigin="anonymous"
    />
    <link
      rel="prefetch"
      href="https://jmthornton.net/assets/fonts/MetroNova-BoldItalic.woff2"
      as="font"
      type="font/woff2"
      crossorigin="anonymous"
    />

    <link
      href="https://jmthornton.net/assets/vendor/prism.min.css"
      rel="stylesheet"
      media="(prefers-color-scheme: light)"
    />
    <!-- <link href="/assets/vendor/prism-dark.min.css" rel="stylesheet" media="(prefers-color-scheme: light)" /> -->
    <link
      href="https://jmthornton.net/assets/vendor/prism-dark.min.css"
      rel="stylesheet"
      media="(prefers-color-scheme: dark)"
    />
    <!-- <link href="/assets/vendor/prism-dark.min.css" rel="stylesheet" media="(prefers-color-scheme: dark)" />
    -->
    <link rel="stylesheet" href="https://jmthornton.net/assets/style/main.css" type="text/css" />
    <!-- TODO switch dev -->
    <!-- <link rel="stylesheet" href="/assets/style/main.css" type="text/css" />
    -->

    <!-- twitter tags reference: https://dev.twitter.com/cards/markup -->
    <!-- opengraph tags reference: http://ogp.me -->

    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@jmthorntonwhat" />
    <meta name="twitter:creator" content="@jmthorntonwhat" />

    <!-- max 70 chars -->
    <meta property="og:title" content="Overriding project.el project root in Emacs" />
    <meta name="twitter:title" content="Overriding project.el project root in Emacs" />

    <!-- max 200 chars -->
    <meta
      name="description"
      content="A short function to override what project.el thinks your project root is with a hidden file"
    />
    <meta
      name="og:description"
      content="A short function to override what project.el thinks your project root is with a hidden file"
    />
    <meta
      name="twitter:description"
      content="A short function to override what project.el thinks your project root is with a hidden file"
    />

    <meta property="og:image" content="https://blog.jmthornton.net/assets/images/icon.png" />
    <meta name="twitter:image" content="https://blog.jmthornton.net/assets/images/icon.png" />

    <meta property="og:url" content="https://blog.jmthornton.net/p/post" />
    <meta property="og:site_name" content="blog.jmthornton.net" />
    <meta property="og:type" content="article" />
    <meta property="og:locale" content="en_US" />

    <meta name="article:author" content="https://blog.jmthornton.net" />
    <meta property="article:published_time" content="2022-05-20" />
  </head>
  <body>
    <header>
      <nav>
        <a href="https://jmthornton.net">Home</a>
        <a href="/tools">Tools</a>
        <a href="https://blog.jmthornton.net">Blog</a>
        <a href="https://photos.jmthornton.net">Photos</a>
      </nav>
    </header>

    <main>
      <article class="post blog-content">
        <h1 class="post-title">Overriding project.el project root in Emacs</h1>
        <time datetime="2022-05-20">May 20, 2022</time>
        <div class="post-main">
          <div class="blog-body">
            <p>
              I've recently been experimenting with replacing
              <a href="https://projectile.mx/">Projectile</a> with the built-in <code>project.el</code>, and
              so far it has impressed me. Not only are all of Projectile's useful features available, but for
              me
              <code>project.el</code>
              runs significantly faster in large repositories. If you're not familiar, both of these packages
              provide functions to search and operate on files and directories in the same project. If you're
              using Git, a "project" is probably synonymous with a repository.
            </p>
            <p>
              Unfortunately, project detection is not always as easy as looking for a
              <code>.git/</code> nearby, and sometimes Emacs gets it wrong. Projectile solves this by also
              looking for a <code>.projectile</code> file, which overrides detection and says "this is the
              project root". This happens to be one of the features missing in <code>project.el</code>.
            </p>
            <p>
              Luckily, we can provide our own function to <code>project.el</code> which looks for a file like
              this in the current and parent directories. Even better, the excellent Emacs community has
              already jumped on this, and a splendid solution was
              <a href="https://michael.stapelberg.ch/posts/2021-04-02-emacs-project-override/"
                >provided by Michael Stapelberg</a
              >.
            </p>
            <p>
              Alas, Michael couldn't have forseen that Emacs would change the project root data format in
              Emacs 29, so the provided function only works in earlier versions. However, adding in forward
              compatibility isn't much trouble. And while we're at it, we can also provide support for anyone
              else moving from Projectile like I am, by allowing <code>.projectile</code> to serve as a
              project root marker alongside Michael's <code>.project.el</code>.
            </p>
            <pre lang="lisp"><code class="language-lisp">(defun project-root-override (dir)
  "Find DIR's project root by searching for a '.project.el' file.

If this file exists, it marks the project root. For convenient compatibility
with Projectile, '.projectile' is also considered a project root marker.

https://blog.jmthornton.net/p/emacs-project-override"
  (let ((root (or (locate-dominating-file dir ".project.el")
                  (locate-dominating-file dir ".projectile")))
        (backend (ignore-errors (vc-responsible-backend dir))))
    (when root (if (version<= emacs-version "28")
                    (cons 'vc root)
                  (list 'vc backend root)))))

;; Note that we cannot use :hook here because `project-find-functions' doesn't
;; end in "-hook", and we can't use this in :init because it won't be defined
;; yet.
(use-package project
  :config
  (add-hook 'project-find-functions #'project-root-override))</code></pre>
            <p>
              Now we can use <code>touch .project.el</code> in any directory, and <code>project.el</code> with
              recognize it as the project root!
            </p>
            <p>
              By the way, the snippet above makes use of
              <a href="https://github.com/jwiegley/use-package">use-package</a> which provides fantastic
              package configuration and loading ability. John Wiegley is currently
              <a href="https://github.com/jwiegley/use-package/issues/282"
                >working on adding it into Emacs itself</a
              >, so it shouldn't be long before this code snippet is fully native!
            </p>
            <p>
              One note, in an ideal world, I'd prefer the root marker to be just <code>.project</code> instead
              of <code>.project.el</code>, but this is already widely used by other tools like Eclipse and I'd
              rather not cause conflicts. If you'd like to use this in your own Emacs, obviously you can
              change the function to check for anything you want.
            </p>
            <aside>
              <em>Pro tip:</em> If you'd like to use a project root marker like this, but you don't want other
              developers to have to worry about it (i.e. you don't want to commit it nor add it to the
              <code>.gitignore</code>), you can always add locally-ignored files to
              <code>.git/info/exclude</code>.
            </aside>
          </div>
        </div>
      </article>
    </main>

    <footer>
      <p>
        Jade Michael Thornton | <a href="https://jmthornton.net">Home</a> |
        <a href="https://gitlab.com/thornjad/jmthornton">Source code</a>
      </p>
    </footer>

    <script src="https://jmthornton.net/assets/vendor/prism.js" defer></script>
    <!-- <script src="/assets/vendor/prism.js" defer></script> -->
  </body>
</html>
